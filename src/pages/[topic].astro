---
import BestWorstCountries from "../components/BestWorstCountries.astro";
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const topics = await getCollection("topics");
  return topics.map((topic) => ({
    params: { topic: topic.id },
    props: { topic: topic.data }
  }));
}

const { topic } = Astro.props;
const [countryInsights, countries] = await Promise.all([
  getCollection("countryInsights"),
  getCollection("countries").then((countries) =>
    countries.map((country) => country.data)
  )
]);
const insights = countryInsights
  .map((insight) =>
    insight.data.map((it) => ({
      ...it,
      countryId: insight.id
    }))
  )
  .flat();

const relatedInsights = insights.filter((insight) =>
  insight.topicIds.includes(topic.id)
);

const title = `${topic.name} – Exceptional Countries`;
---

<Layout title={title}>
  <div class="flex flex-col gap-4">
    <div>
      <h2 class="text-center">{title}</h2>
      <p class="text-center text-gray-500 text-sm">
        Exploring the best and worst performers across {topic.name} indicators
      </p>
    </div>
    <BestWorstCountries insights={relatedInsights} countries={countries} />
    <h2 class="text-center">Global – Exceptional Countries</h2>
    <BestWorstCountries insights={insights} countries={countries} />
  </div>
</Layout>
