---
import InsightList from "../components/InsightList.astro";
import Layout from "../layouts/Layout.astro";
import { getCollection, getEntry } from "astro:content";

export async function getStaticPaths() {
  const countries = await getCollection("countries");
  return countries.map((country) => ({
    params: { country: country.data.slug },
    props: { country: country.data }
  }));
}

const { country } = Astro.props;
const [tops, topics] = await Promise.all([
  getEntry("countryInsights", country.id)!.then((t) => t.data),
  getCollection("topics")
]);

const getTopic = (id: string) => {
  return topics.find((topic) => topic.id === id)!.data;
};

const bestIn = tops
  .filter((it) => it.type === "GOOD")
  .sort((a, b) => b.year - a.year)
  .map((item) => ({
    ...item,
    topics: item.topicIds.map(getTopic)
  }));
const worstIn = tops
  .filter((it) => it.type === "BAD")
  .sort((a, b) => b.year - a.year)
  .map((item) => ({
    ...item,
    topics: item.topicIds.map(getTopic)
  }));
const title = `Best and Worst in ${country.name}`;
const description = `Explore the best and worst indicators for ${country.name} across various topics.`;
const canonical = `/${country.slug}/`;
---

<Layout title={title} description={description} canonical={canonical}>
  <div class="flex flex-col gap-4">
    <h2 class="text-good">{country.name} in the Lead</h2>
    <InsightList list={bestIn} type="GOOD" />
    <h2 class="text-bad">{country.name} Falling Behind</h2>
    <InsightList list={worstIn} type="BAD" />
  </div>
  <script is:inline>
    function toggleDescription(header) {
      const icon = header.querySelector("svg");
      const desc = header.nextElementSibling;
      const isOpen = desc.style.height && desc.style.height !== "0px";

      if (isOpen) {
        desc.style.height = desc.scrollHeight + "px"; // ensure accurate starting point
        requestAnimationFrame(() => (desc.style.height = "0px"));
      } else {
        desc.style.height = desc.scrollHeight + "px";
        desc.addEventListener("transitionend", function handler() {
          desc.style.height = "auto";
          desc.removeEventListener("transitionend", handler);
        });
      }

      icon.classList.toggle("rotate-180");
    }
  </script>
</Layout>
